HCanAWR.views.RecallBrowserView = Ext.extend(Ext.Panel, {
	viewName: 'RecallBrowser',
	id: 'recallBrowserView',
	scroll: 'vertical',
	conf: {
		ITEMAPPROXHEIGHT: 70
	},
	
	itemsList:	['topTitle', 'search', 'categorySelect', 'categories',
				'middleTitle', 'results', 'messagePanel', 'loadMoreButton', 'tabBarClearance'],
	
	init: function(store, callback) {
		var that = this,
			categoryOptions = [];
		
		/* Top Banner */
		this.topBanner = new HCanAWR.views.TopBanner();
		this.topBanner.dock = 'top';
		
		/* Top Title */
		this.topTitle = new Ext.Container({
			html: getStr('recallBrowser_TopTitle'),
			cls: 'recallBrowserTopTitle'
		});
		
		/* Search */
		if (!Ext.is.Android) {
			this.search = new Ext.form.Search({
				cls: 'recallBrowserSearchField',
				placeHolder: getStr('recallBrowser_SearchPlaceHolder')
			});
		} else {
			this.search = new Ext.Container({
				cls: 'recallBrowserSearchBox',
				html: getStr('recallBrowser_SearchPlaceHolder')
			});
		}
		
		/* Category Dropdown (search mode) */
		Ext.each(
			(new Array()).concat([HCanAWR.conf.ALLCATEGORIES],HCanAWR.itemCategories),
			function(item) {
				categoryOptions.push({text: getStr('categoryTitle_'+item), value: item});
			},
			this
		);
		
		this.categorySelect = new Ext.form.Select({
			cls: 'recallBrowserCategorySelector',
			name: 'recallBrowserCategorySelector', // silence an error.
			options: categoryOptions,
			value: HCanAWR.conf.ALLCATEGORIES
		});
		
		/* Category Icons (browse mode) */
		this.categories = new Ext.Panel({
			cls: 'recallBrowserCategoriesPanel',
		});
		var CategoryContainer = Ext.extend(Ext.Container, { categoryEnabled: false });
		Ext.each( HCanAWR.itemCategories, function(category) {
			var blankImage = 'data:image/gif;base64,R0lGODlhAQABAID/AMDAwAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==';
			this.categories.add(new CategoryContainer({
				id: 'categoryImageContainer$'+category,
				cls: 'categoryIconButtonContainer',
				width: (100/HCanAWR.itemCategories.length)+'%',
				html: '<img class="categoryIconButton categoryIconButton_'+category+'" id="categoryImage$'+category+'" src="'+blankImage+'" />',
			}));
		}, this);
		
		/* Middle Title */
		this.middleTitle = new (Ext.extend(Ext.Panel, {
			cls: 'recallBrowserMiddleTitle',
			items: [
				{
					id: 'recallBrowserMiddleTitle$Recent',
					xtype: 'container',
					cls: 'recallBrowserMiddleTitleText',
					hidden: true,
					html: getStr('recallBrowser_MiddleTitleText_Recent')
				},
				{
					id: 'recallBrowserMiddleTitle$Search',
					xtype: 'container',
					cls: 'recallBrowserMiddleTitleText',
					hidden: true,
					html: getStr('recallBrowser_MiddleTitleText_Search')
				},
			],
			
			/* The following kludge solves an issue on iOS where the text gets cut off. */
			setTextByName: function(name) {
				this.items.findBy(function(item) {
					if (item.id == 'recallBrowserMiddleTitle$'+name) {
						item.show()
					} else {
						item.hide();
					}
				});
			}
		}))();
		
		/* Results List */
		var resultsTpl = new Ext.XTemplate(
			'<span class="recallBrowserResultId">{recallId}</span>',
			'<span class="recallBrowserResultCategory recallBrowserResultCategory_{category}">',
			'<tpl if="isRead">&nbsp;</tpl><tpl if="!isRead"><img src="images/unread_icn.png"></tpl>',
			'</span>',
			'<div>',
				'<tpl if="isRead"><span class="recallBrowserResultTitle">{title}</span></tpl>',
				'<tpl if="!isRead"><span class="recallBrowserResultTitle recallBrowserResultTitle_Unread">{title}</span></tpl>',
				'<span class="recallBrowserResultDate">{date_readable}</span>',
			'</div>',
			'<img class="recallBrowserResultDisclose" src="images/chevron.png">'
		);
		
		this.results = new Ext.List({
			cls: 'recallBrowserResultsList',
			selectedItemCls: 'nothing',
			scroll: false,
			store: store,
			itemTpl: resultsTpl,
			itemCls: 'recallBrowserResultsListItem',
			itemSelector: '.recallBrowserResultsListItem',
		});
		
		/* No Results / Search Message Panel */
		this.messagePanel = new Ext.Container({
			cls: 'recallBrowserMessagePanel',
			html: '' // To be set later.
		});
		
		/* Load More Results Button */
		this.loadMoreButton = new Ext.Button({
			baseCls: 'nothing',
			cls: 'recallBrowserLoadMore',
			text: getStr('recallBrowser_LoadMore')
		});
		
		/* Tab Bar Clearance Hack */
		this.tabBarClearance = new Ext.Component({
			cls: 'recallBrowserTabBarClearance',
			html: '&nbsp;'
		});
		
		/* Add all of the UI elements to the view. */
		this.addDocked(this.topBanner);
		Ext.each(this.itemsList, function(item) {
			this.add(this[item]);
			
			// do the layout of child items when doing layout of this view.
			this.mon(
				this,
				'afterlayout',
				function() {
					this[item].doComponentLayout();
				},
				this,
				{ single: true }
			);
		}, this);
		
		callback();
	},
	
	highlightCategory: function(category, forceHighlight) {
		if (forceHighlight === undefined) {
			forceHighlight = false;
		}
		this.categories.items.each(function(container) {
			var catId = container.id.replace('categoryImageContainer$', ''),
				notificationStr = catId+'Notifications',
				notificationIsOn = HCanAWR.appSettings.getNotificationSetting(notificationStr),
				categoryImage = container.el.down('img.categoryIconButton'),
				focusCls = 'categoryIconButtonContainerFocused',
				disableCls = 'categoryIconButtonDisabled';
			
			if (notificationIsOn) {
				categoryImage.removeCls(disableCls);
				
				if (catId == category) {
					if (container.categoryEnabled && !forceHighlight) {
						container.removeCls(focusCls);
						container.categoryEnabled = false;
					} else {
						container.addCls(focusCls);
						container.categoryEnabled = true;
					}
				} else {
					container.categoryEnabled = false;
					container.removeCls(focusCls);
				}
			} else {
				container.categoryEnabled = false;
				container.removeCls(focusCls);
				
				categoryImage.addCls(disableCls);
			}
		});
	},
	
	showSearchRecalls: function() {
		this.middleTitle.setTextByName('Search');
		
		this.categories.hide();
		this.results.hide();
		
		this.search.show();
		this.categorySelect.show();
		this.scroller.scrollTo({x:0,y:0});
	},
	
	showRecentRecalls: function() {
		this.scroller.scrollTo({x:0,y:0});
		
		this.middleTitle.setTextByName('Recent');
		
		this.search.hide();
		this.categorySelect.hide();
		this.results.hide();
		this.loadMoreButton.hide();
		
		this.messagePanel.update('');
		
		this.categories.show();
		this.results.show();
		
	},
	
	populateRecallList: function(store, ignoreNoResults) {
		if (ignoreNoResults === undefined) {
			ignoreNoResults = false;
		}
		
		this.results.bindStore(store);
		
		if (store.getCount() == 0) {
			if (ignoreNoResults) {
				this.showSearchError( getStr('recallBrowser_SearchMessage') );
			} else {
				this.showSearchError( getStr('recallBrowser_NoResults') );
			}
			this.messagePanel.show();
		} else {
			this.messagePanel.hide();
			this.results.show();
		}
	},
	
	showSearchError: function(message) {
		this.messagePanel.update(message);
		
		this.results.hide();
		this.loadMoreButton.hide();
		
		this.messagePanel.show();
	},
	
	showLoadMoreButton: function() {
		this.loadMoreButton.show();
	},
	
	hideLoadMoreButton: function() {
		this.loadMoreButton.hide();
	},
	
});

